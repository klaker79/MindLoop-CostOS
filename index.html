        const busqueda = document.getElementById('busqueda-inventario').value.toLowerCase();
                        const filtrados = inventario.filter(ing =>
                            ing.nombre.toLowerCase().includes(busqueda)
                        );

                        const container = document.getElementById('tabla-inventario');

                        // Calcular alertas
                        let stockBajo = 0;
                        let stockCritico = 0;

                        window.ingredientes.forEach(ing => {
                            const stockActual = parseFloat(ing.stock_actual) || 0;
                            const stockMinimo = parseFloat(ing.stock_minimo) || 0;
                            // Solo contar si tiene m√≠nimo configurado
                            if (stockActual <= 0) {
                                stockCritico++;
                            } else if (stockMinimo > 0 && stockActual <= stockMinimo) {
                                stockBajo++;
                            }
                        });

                        // Actualizar badge
                        const totalAlertas = stockBajo + stockCritico;
                        const badge = document.getElementById('badge-inventario');
                        if (totalAlertas > 0) {
                            badge.textContent = totalAlertas;
                            badge.style.display = 'inline-block';
                        } else {
                            badge.style.display = 'none';
                        }

                        // Actualizar resumen
                        const resumen = document.getElementById('resumen-inventario');
                        if (stockBajo > 0 || stockCritico > 0) {
                            resumen.innerHTML = `
            <div style="color: #f59e0b;">‚ö†Ô∏è Stock bajo: <strong>${stockBajo}</strong></div>
            <div style="color: #ef4444;">üî¥ Stock cr√≠tico: <strong>${stockCritico}</strong></div>
          `;
                            resumen.style.display = 'flex';
                        } else {
                            resumen.style.display = 'none';
                        }

                        if (filtrados.length === 0) {
                            container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üì¶</div>
              <h3>No hay ingredientes</h3>
              <p>A√±ade ingredientes para gestionar el inventario</p>
            </div>
          `;
                            return;
                        }

                        let html = '<table><thead><tr>';
                        html += '<th>Estado</th><th>Ingrediente</th><th>Stock</th><th>Stock Real</th><th>Diferencia</th><th>Precio Medio</th><th>Valor Stock</th><th>Unidad</th>';
                        html += '</tr></thead><tbody>';

                        filtrados.forEach(ing => {
                            let estadoClass = 'stock-ok';
                            let estadoIcon = 'üü¢';

                            const stockActual = parseFloat(ing.stock_actual) || 0;
                            const stockMinimo = parseFloat(ing.stock_minimo) || 0;

                            if (stockActual <= 0) {
                                estadoClass = 'stock-critico';
                                estadoIcon = 'üî¥';
                            } else if (stockMinimo > 0 && stockActual <= stockMinimo) {
                                estadoClass = 'stock-bajo';
                                estadoIcon = 'üü°';
                            }

                            const precioMedio = parseFloat(ing.precio || 0);
                            const valorStock = stockActual * precioMedio;
                            const stockReal = ing.stock_real !== null ? parseFloat(ing.stock_real).toFixed(2) : '';

                            html += '<tr>';
                            html += `<td><span class="stock-indicator ${estadoClass}"></span>${estadoIcon}</td>`;
                            html += `<td><strong>${ing.nombre}</strong></td>`;
                            html += `<td><span class="stock-value">${stockActual.toFixed(2)}</span></td>`;

                            // Input para stock real
                            html += `<td><input type="number" step="0.01" value="${stockReal}" placeholder="Sin datos" 
                        class="input-stock-real" 
                        data-id="${ing.id}" 
                        data-stock-virtual="${stockActual}" 
                        data-precio="${precioMedio}"
                        oninput="window.updateDifferenceCell(this)"
                        style="width:80px;padding:5px;border:1px solid #ddd;border-radius:4px;"></td>`;

                            // Celda de Diferencia
                            let diffDisplay = '-';
                            let diffColor = '#666';

                            if (stockReal !== '' && stockReal !== null) {
                                const d = parseFloat(stockReal) - stockActual;
                                diffDisplay = d.toFixed(2);
                                if (d < 0) diffColor = '#ef4444';
                                else if (d > 0) diffColor = '#10b981';
                            }

                            html += `<td id="diff-cell-${ing.id}" style="color:${diffColor}; font-weight:bold;">${diffDisplay}</td>`;

                            html += `<td>${precioMedio.toFixed(2)}‚Ç¨/${ing.unidad}</td>`;

                            // Valor Stock
                            const cantidadParaValor = (stockReal !== '' && stockReal !== null) ? parseFloat(stockReal) : stockActual;
                            const valorStockDisplay = (cantidadParaValor * precioMedio).toFixed(2);

                            html += `<td id="val-cell-${ing.id}"><strong>${valorStockDisplay}‚Ç¨</strong></td>`;
                            html += `<td>${ing.unidad}</td>`;
                            html += '</tr>';
                        });

                        container.innerHTML = html;
                    } catch (error) {
                        console.error('Error:', error);
                        document.getElementById('tabla-inventario').innerHTML = '<p style="color:#ef4444;">Error cargando inventario</p>';
                    }
                };

                window.updateDifferenceCell = function (input) {
                    const id = input.dataset.id;
                    const virtual = parseFloat(input.dataset.stockVirtual) || 0;
                  
